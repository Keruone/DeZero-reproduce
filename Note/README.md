# DeZero å­¦ä¹ è®°å½•
æœ¬æ–‡ç”¨æ¥è®°å½• å¤ç°DeZero è¿‡ç¨‹ä¸­ï¼Œå„ç§çœ‹ä¹¦ç¬¬ä¸€çœ¼ä¸èƒ½ç†è§£çš„ã€æˆ–ä¹¦ä¸­ç•¥è¿‡çš„çŸ¥è¯†ã€‚

- [DeZero å­¦ä¹ è®°å½•](#dezero-å­¦ä¹ è®°å½•)
	- [Step 12: `*`åœ¨pythonçš„éƒ¨åˆ†ä½œç”¨](#step-12-åœ¨pythonçš„éƒ¨åˆ†ä½œç”¨)
	- [step 14: `x.grad += gx` ä¼šå¯¼è‡´æ¢¯åº¦å‡ºé—®é¢˜](#step-14-xgrad--gx-ä¼šå¯¼è‡´æ¢¯åº¦å‡ºé—®é¢˜)
		- [ç°å›é¡¾æ¡ˆå‘ç°åœºï¼š](#ç°å›é¡¾æ¡ˆå‘ç°åœº)
		- [æ¡ˆä»¶åˆ†æï¼š](#æ¡ˆä»¶åˆ†æ)
		- [æ€»ç»“](#æ€»ç»“)
	- [step 15-17: æ ¸å¿ƒè®¾è®¡ï¼šèŒè´£åˆ†ç¦»](#step-15-17-æ ¸å¿ƒè®¾è®¡èŒè´£åˆ†ç¦»)
		- [1. ä¸ºä»€ä¹ˆè¦åšèŒè´£åˆ†ç¦»ï¼Ÿ](#1-ä¸ºä»€ä¹ˆè¦åšèŒè´£åˆ†ç¦»)
		- [2. å¼•å…¥å¼±é“¾æ¥](#2-å¼•å…¥å¼±é“¾æ¥)
		- [3. lambda x: x](#3-lambda-x-x)
	- [step 18: yieldä¸è£…é¥°å™¨](#step-18-yieldä¸è£…é¥°å™¨)
		- [1. yield](#1-yield)
		- [2. @contextlib.contextmanager è£…é¥°å™¨](#2-contextlibcontextmanager-è£…é¥°å™¨)
	- [Step 39: ä¹¦ä¸­æœªè®²æ˜çš„ utils.reshape\_sum\_backward() å‡½æ•°åˆ†æ](#step-39-ä¹¦ä¸­æœªè®²æ˜çš„-utilsreshape_sum_backward-å‡½æ•°åˆ†æ)
		- [1. ä½¿ç”¨çš„åœºæ™¯](#1-ä½¿ç”¨çš„åœºæ™¯)
		- [2. å‡½æ•°çš„å…·ä½“åˆ†æ](#2-å‡½æ•°çš„å…·ä½“åˆ†æ)
	- [Step 40: ä¹¦ä¸­æœªè®²æ˜çš„ utils.sum\_to å‡½æ•°åˆ†æ](#step-40-ä¹¦ä¸­æœªè®²æ˜çš„-utilssum_to-å‡½æ•°åˆ†æ)
		- [1. ä½ åº”è¯¥çŸ¥é“çš„ numpy å¹¿æ’­ç‰¹ç‚¹](#1-ä½ åº”è¯¥çŸ¥é“çš„-numpy-å¹¿æ’­ç‰¹ç‚¹)
		- [2. å…·ä½“å‡½æ•°åˆ†æ](#2-å…·ä½“å‡½æ•°åˆ†æ)
	- [Step 44: `super()` ä»¥åŠ `__setattr__`](#step-44-super-ä»¥åŠ-__setattr__)
		- [1. `super()`](#1-super)
		- [2. `__setattr__` å³å…¶èµ‹å€¼è¯­æ³•](#2-__setattr__-å³å…¶èµ‹å€¼è¯­æ³•)
	- [Step 48: å¤ç°æ—¶é‡åˆ°çš„é—®é¢˜](#step-48-å¤ç°æ—¶é‡åˆ°çš„é—®é¢˜)
		- [1. éœ€è¦å‚è€ƒé™„å½•Bå®ç° get\_item](#1-éœ€è¦å‚è€ƒé™„å½•bå®ç°-get_item)
		- [2. éœ€è¦åœ¨utilsä¸­è¡¥å……ä»£ç ï¼š](#2-éœ€è¦åœ¨utilsä¸­è¡¥å……ä»£ç )
		- [3. function ä¸­è¡¥å……çš„ä»£ç ï¼š](#3-function-ä¸­è¡¥å……çš„ä»£ç )
		- [4. `t.ravel()`](#4-travel)


---
## Step 12: `*`åœ¨pythonçš„éƒ¨åˆ†ä½œç”¨
å…³äº "*" åœ¨ python çš„ä½œç”¨ï¼Œå¯ä»¥å°è¯•è¿è¡Œæˆ‘åœ¨è¿™é‡Œçš„[ä»£ç ](../example/python_args_unpack_demo.py)

æ€»ç»“å¦‚ä¸‹ï¼š
1. `*args` ä½œç”¨ï¼šæŠŠã€Œå¤šä¸ªç‹¬ç«‹å‚æ•°ã€æ‰“åŒ…æˆã€Œå…ƒç»„ã€ï¼ˆæ°¸è¿œæ˜¯å…ƒç»„ï¼‰",
2. `*åˆ—è¡¨` ä½œç”¨ï¼šæŠŠã€Œåˆ—è¡¨/å…ƒç»„ã€è§£åŒ…æˆã€Œå¤šä¸ªç‹¬ç«‹å‚æ•°ã€",
3. **ç›´æ¥**ä¼ åˆ—è¡¨ â†’ `args` = (åˆ—è¡¨,)ï¼ˆå…ƒç»„é‡Œåªæœ‰1ä¸ªå…ƒç´ ï¼šåˆ—è¡¨ï¼‰",
4. **è§£åŒ…**ä¼ åˆ—è¡¨ â†’ `args` = (åˆ—è¡¨å…ƒç´ 1, åˆ—è¡¨å…ƒç´ 2, ...)ï¼ˆå…ƒç»„é•¿åº¦=åˆ—è¡¨é•¿åº¦ï¼‰",
5. æ˜“é”™ç‚¹ï¼šç›´æ¥ä¼ åˆ—è¡¨æ—¶ï¼Œ`args[0]` æ˜¯åˆ—è¡¨**æœ¬èº«**ï¼Œä¸æ˜¯åˆ—è¡¨é‡Œçš„å…ƒç´ "

---
## step 14: `x.grad += gx` ä¼šå¯¼è‡´æ¢¯åº¦å‡ºé—®é¢˜
è¿™ä¸ªé—®é¢˜æ˜¯åœ¨æ‰§è¡Œ[step 14](../step/step14.py)æ—¶ï¼Œå‡ºç°çš„é—®é¢˜ã€‚
ä½ åº”è¯¥å¯ä»¥åœ¨æˆ‘çš„[ä»£ç ](../step/step14.py)ä¸­å‘ç°æœ‰ä¸€å— `#!` æ³¨é‡Šçš„åœ°æ–¹ï¼Œé‚£é‡Œæ˜¯æ¡ˆå‘ç°åœº

### ç°å›é¡¾æ¡ˆå‘ç°åœºï¼š
- å½“æ—¶ï¼Œä»£ç ä¸º`x.grad += gx`ã€‚æ­¤æ—¶è¿è¡Œæµ‹è¯•ä¾‹ç¨‹ï¼ˆå¦‚ä¸‹ï¼‰ä½ ä¼šå‘ç°ï¼Œç»“æœæ˜¯**4**ï¼ˆé¢„æœŸæ˜¯ 3ï¼‰ã€‚å¯¹äºåƒæˆ‘ä¸€æ ·åº•å­æ˜¯`C`æ‰“å‡ºæ¥çš„ï¼Œpythonæ˜¯è¾¹ç”¨è¾¹å­¦çš„ï¼Œè‚¯å®šæ­¤æ—¶ä¼šæ„Ÿåˆ°å›°æƒ‘ï¼
	```python
		def test_multi_3x(self):
			x0 = Variable(np.array(3))
			y0 = add(add(x0, x0), x0)
			y0.backward()
			self.assertEqual(x0.grad, 3)
	```
- ç„¶åå±•å¼€è°ƒè¯•ï¼Œä½ ä¼šå‘ç°ä»£ç ä¸­çš„`gx`åœ¨ç¬¬äºŒæ¬¡åå‘ä¼ æ’­åä»ç„¶æ­£ç¡®ï¼Œä½†æ˜¯å¦‚æœä½ ä»”ç»†è§‚å¯Ÿ`gy`ï¼Œä¼šå‘ç°æ€ä¹ˆå˜æˆ**2**äº†ï¼Ÿï¼Ÿï¼ŸğŸ˜•

### æ¡ˆä»¶åˆ†æï¼š
- æ¡ˆå‘åŸå› 1ï¼š
  - è¿™é‡Œæœ€æŠ½è±¡çš„åœ°æ–¹ï¼Œå°±æ˜¯ï¼špythonçš„èµ‹å€¼ï¼Œå…¶å®æ˜¯å¯¹è±¡å¼•ç”¨ï¼ˆä¹Ÿå› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œpythonæœ‰ä»€ä¹ˆæ·±å¤åˆ¶ã€æµ…å¤åˆ¶ç­‰ç­‰å¥‡æ€ªä¸œè¥¿ï¼‰
  - ä¸¾ä¸ªä¾‹å­
  	```python
  	# ç¬¬ä¸€è¡Œï¼šåˆ›å»ºæ•°ç»„å¹¶èµ‹å€¼ï¼ˆå¯¹åº”ä½  x0.grad = gxï¼‰
  	a = np.array(1)
  	b = a
  	# ç¬¬äºŒè¡Œï¼šä¿®æ”¹bï¼Œaä¹Ÿå˜äº†ï¼ˆå¯¹åº”ä½  gy è«åå˜2ï¼‰
  	b += 1; print(a, b)  # è¾“å‡ºï¼š2 2ï¼ˆä¸æ˜¯ä½ ä»¥ä¸ºçš„ 1 2ï¼ï¼‰
  	```
  - è€Œè¿™æ­£å¼æ¡ˆå‘çš„**åŸå› å…¶ä¸€**ï¼å…¶å®ä½ ä»”ç»†è§‚å¯Ÿå‰é¢ä»£ç ï¼Œå¯ä»¥å‘ç°å…¨éƒ¨çš„â€œèµ‹å€¼â€éƒ½æ˜¯å¼•ç”¨ï¼
	> ***\*æ³¨æ„***ï¼ŒPythonä¼ å‚æ˜¯**ä¼ å¯¹è±¡å¼•ç”¨ï¼ˆpass-by-object-referenceï¼‰**ï¼‰
  - æ‰€ä»¥åœ¨`add()`åå‘ä¼ æ’­æ—¶ï¼Œç›´æ¥å°†`gys`è¿”å›äº†ï¼Œç„¶ååˆâ€œèµ‹å€¼â€åˆ°`gxs`ï¼Œè€Œ`gx`åˆæ˜¯ç›´æ¥ä»`gxs`ä¸­å–å‡ºï¼Œåˆèµ‹å€¼ç»™`x.grad`ã€‚é‚£è¿™ä¹ˆå…œäº†ä¸€åœˆåï¼Œ**`x.grad`å’Œ`gy`å°±ç»™ç»‘ä¸Šäº†åŒä¸€ä¸ªå¯¹è±¡**ï¼ï¼ˆçœŸæ˜¯ä¸€å¯¹è‹¦å‘½é¸³é¸¯å•ŠğŸ˜­ï¼‰
- æ¡ˆå‘åŸå› 2ï¼š
  - åœ¨çŸ¥é“â€œå¯¹è±¡å¼•ç”¨â€çš„ç‰¹æ€§åï¼Œä½ åº”è¯¥è¿˜è¦çŸ¥é“ï¼šå¤§å¤šæ•°è¿ç®—ï¼ˆå¦‚ a + bï¼‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œç„¶åèµ‹å€¼æ“ä½œï¼ˆx = ...ï¼‰ä¼šè®©å˜é‡åé‡æ–°ç»‘å®šåˆ°è¿™ä¸ªæ–°å¯¹è±¡ã€‚
  - ä½†æ˜¯ `+=` ä¸æ˜¯å•Šï¼
	> åŸåœ°è¿ç®—ç¬¦ï¼ˆå¦‚ +=, *=, etc.ï¼‰å¯¹å¯å˜å¯¹è±¡ï¼ˆå¦‚ list, np.ndarrayï¼‰ä¼šå°è¯•ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡çš„å†…å®¹ï¼ˆin-placeï¼‰ï¼Œè€Œä¸æ”¹å˜å…¶èº«ä»½ï¼ˆid ä¸å˜ï¼‰ï¼›å¯¹ä¸å¯å˜å¯¹è±¡ï¼ˆå¦‚ int, strï¼‰ï¼Œåˆ™é€€åŒ–ä¸ºæ™®é€šèµ‹å€¼ï¼ˆåˆ›å»ºæ–°å¯¹è±¡ï¼‰ã€‚
  - è¿™å°±ç ´æ¡ˆäº†å•Šï¼é€†å¤©çš„åŸåœ°è¿ç®—ä¼šå¯¼è‡´ä½ çš„`gy`éšç€`x.grad`åŒæ­¥å¢åŠ ï¼

### æ€»ç»“
è¿™æ˜¯ Python æ–°æ‰‹ï¼ˆå°¤å…¶ C èƒŒæ™¯ï¼‰ææ˜“è¸©çš„å‘ğŸ’”ï¼šæ—¢å®¹æ˜“å¿½ç•¥ã€Œèµ‹å€¼ = å¼•ç”¨ã€çš„ç‰¹æ€§ï¼Œåˆæ²¡æ„è¯†åˆ°ã€ŒåŸåœ°è¿ç®—ç¬¦ã€å¯¹å¯å˜å¯¹è±¡çš„ä¿®æ”¹ä¼šå½±å“æ‰€æœ‰å¼•ç”¨è¯¥å¯¹è±¡çš„å˜é‡ã€‚

---
## step 15-17: æ ¸å¿ƒè®¾è®¡ï¼šèŒè´£åˆ†ç¦»
åœ¨å®ç° `generation` èµ‹å€¼é€»è¾‘æ—¶ï¼Œæ ¸å¿ƒè®¾è®¡å†³ç­–æ˜¯ï¼šå°†ã€ŒVariable è¾ˆåˆ†è®¾ç½®ã€çš„é€»è¾‘æ”¾åœ¨ `Variable.set_creator` ä¸­ã€‚
ä½†æ˜¯è¿™è®©æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ**é€‰æ‹©`Variable.set_creator`è€Œé Function.__call__ é‡Œå®ç°**ï¼Ÿ
åæ¥ç®€å•äº†è§£ä»¥ä¸‹ï¼Œå¾—çŸ¥å¯èƒ½ä¸**èŒè´£åˆ†ç¦»**åŸåˆ™æœ‰å…³

### 1. ä¸ºä»€ä¹ˆè¦åšèŒè´£åˆ†ç¦»ï¼Ÿ
- åé¢è®¾è®¡ï¼ˆä¸å¯å–ï¼‰ï¼šFunction æ“æ§ Variable å†…éƒ¨å±æ€§
å¦‚æœåœ¨ Function.__call__ ä¸­ç›´æ¥ä¿®æ”¹ Variable çš„ generationï¼š
	```python
	# âŒ è¿èƒŒèŒè´£åˆ†ç¦»ï¼šFunction ä¾µå…¥ Variable å†…éƒ¨é€»è¾‘
	def __call__(self, *inputs):
		# ... å…¶ä»–é€»è¾‘ ...
		for output in outputs:
			output.creator = self
			output.generation = self.generation + 1  # Function ç›´æ¥æ”¹ Variable å±æ€§
	```
	é—®é¢˜ï¼š
	- è€¦åˆåº¦æé«˜ï¼šFunction å¿…é¡»çŸ¥é“ Variable æœ‰ generation å±æ€§ï¼Œä¸”çŸ¥é“å…¶è®¡ç®—è§„åˆ™ï¼ˆ+1ï¼‰ï¼›
	- æ‰©å±•æ€§å·®ï¼šè‹¥åç»­ä¿®æ”¹ generation è®¡ç®—è§„åˆ™ï¼ˆæ¯”å¦‚ +2ï¼‰ï¼Œæ‰€æœ‰ Function éƒ½è¦åŒæ­¥ä¿®æ”¹ï¼›
	- è¿èƒŒã€Œå¯¹è±¡è‡ªæ²»ã€ï¼šVariable æ— æ³•è‡ªå·±æŒæ§æ ¸å¿ƒå±æ€§ï¼Œæ²¦ä¸º Function çš„ â€œé™„å±å“â€ã€‚
- æ­£é¢è®¾è®¡ï¼ˆä»£ç ä¸­é‡‡ç”¨ï¼‰ï¼šVariable è‡ªæ²»æ ¸å¿ƒå±æ€§
	```python
	# âœ… ç¬¦åˆèŒè´£åˆ†ç¦»ï¼šVariable è‡ªå·±ç®¡ç†æ ¸å¿ƒå±æ€§
	class Variable:
		def set_creator(self, func):
			self.creator = func
			self.generation = func.generation + 1  # Variable è‡ªä¸»å†³å®šè¾ˆåˆ†è®¡ç®—è§„åˆ™
	```
	ä¼˜åŠ¿ï¼š
	- è¾¹ç•Œæ¸…æ™°ï¼š
		- Function ä»…è´Ÿè´£ã€Œè®¡ç®—é€»è¾‘ã€+ã€Œé€šçŸ¥ Variableï¼šæˆ‘åˆ›å»ºäº†ä½ ã€ï¼ˆè°ƒç”¨ set_creatorï¼‰ï¼Œæ— éœ€çŸ¥é“ Variable å†…éƒ¨å¦‚ä½•å¤„ç†ï¼›
		- Variable ä»…è´Ÿè´£ã€Œç®¡ç†è‡ªèº«æ•°æ® / æ¢¯åº¦ / è¾ˆåˆ†ã€ï¼Œæ— éœ€ä¾èµ– Function çš„å®ç°ç»†èŠ‚ï¼›
	- å¯ç»´æŠ¤æ€§å¼ºï¼šä¿®æ”¹ generation è§„åˆ™æ—¶ï¼Œåªæ”¹ Variable.set_creator ä¸€ä¸ªåœ°æ–¹å³å¯ï¼›
	- ç¬¦åˆç›´è§‰ï¼šå°±åƒ â€œå­©å­çŸ¥é“è‡ªå·±çš„çˆ¶æ¯ï¼ˆcreatorï¼‰ï¼Œå¹¶è‡ªä¸»è®¡ç®—è‡ªå·±çš„è¾ˆåˆ†ï¼Œè€Œéçˆ¶æ¯å¼ºè¡Œè´´æ ‡ç­¾â€ã€‚

### 2. å¼•å…¥å¼±é“¾æ¥
å¼•å…¥å¼±é“¾æ¥çš„ç¼˜ç”±ï¼Œé™¤äº†ä¹¦ä¸­æåŠçš„å†…å­˜ç®¡ç†çš„åŸå› ï¼ˆè¿™å½“ç„¶ä¹Ÿéå¸¸é‡è¦ï¼‰ï¼Œæˆ‘æƒ³æŸç§è§’åº¦æ¥è¯´ä¹Ÿæ˜¯è·Ÿ**èŒè´£åˆ†ç¦»**ç›¸å…³çš„ã€‚
- è¿™é‡Œçš„å¼±é“¾æ¥ä¸»è¦ä¿®æ”¹å¯¹è±¡è¿˜æ˜¯å‡½æ•°ï¼Œå®ƒç¡®ä¿äº†å¯¹äºå‡½æ•°è€Œè¨€ï¼Œå®ƒå¯¹è°ƒç”¨å®ƒçš„å¯¹è±¡ï¼ˆè¾“å…¥ï¼‰ä¿æŒå¼ºé“¾æ¥ï¼Œå¯¹äºå®ƒçš„è®¡ç®—ç»“æœï¼ˆè¾“å‡ºï¼‰ä¿æŒäº†å¼±é“¾æ¥ã€‚
  > Function åªå®Œæˆã€Œç”Ÿæˆè¾“å‡ºã€çš„æ ¸å¿ƒèŒè´£ï¼Œè¾“å‡ºå˜é‡çš„ç”Ÿå‘½å‘¨æœŸç”±ã€Œä½¿ç”¨å®ƒçš„ä»£ç ã€å†³å®šï¼Œè€Œéç”Ÿäº§è€…ï¼ˆFunctionï¼‰â€”â€” å½»åº•åˆ‡æ–­ Function å¯¹è¾“å‡ºçš„ â€œè¿‡åº¦è´£ä»»â€ã€‚
- è€Œå¯¹äºå˜é‡ï¼Œå®ƒä»…è®°ä½è‡ªå·±çš„åˆ›å»ºè€…ï¼ˆè¾“å‡ºè‡ªå·±çš„å‡½æ•°ï¼‰ï¼Œä½†ä»ä¸è€ƒè™‘è°ä¼šä½¿ç”¨å®ƒã€‚
  > è‹¥ Variable è®°å½• â€œä½¿ç”¨è€…â€ï¼Œä¼šå¯¼è‡´ï¼šâ‘  è€¦åˆæ‰€æœ‰ä½¿ç”¨å®ƒçš„ Function/Variableï¼›â‘¡ å¼•å…¥æ–°çš„å¾ªç¯å¼•ç”¨ï¼›â‘¢ è¿èƒŒ â€œåªå…³æ³¨è‡ªèº«æ¥æºâ€ çš„èŒè´£ã€‚
- å…¶å®è¿™ä¹Ÿæ˜¯ä¸€ç§éµå¾ªäº†èŒè´£åˆ†ç¦»çš„ä»£ç ç¼–å†™æ–¹å¼
- æœ€ç»ˆå®ç°ï¼šæ¯ä¸ªå¯¹è±¡åªå¯¹ã€Œè‡ªå·±èŒè´£èŒƒå›´å†…çš„ä¾èµ–ã€è´Ÿè´£ï¼Œä¸æ’æ‰‹ã€Œæ— å…³çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€ã€‚

### 3. lambda x: x
è¿™æ˜¯ä¸€ä¸ªpythonçš„åŒ¿åå‡½æ•°ï¼ˆæ²¡æœ‰æ˜¾å¼å‡½æ•°åï¼‰ `lambda` å’Œ `:` ä¹‹é—´çš„è¡¨ç¤ºè¾“å…¥å‚æ•°ï¼Œ`:`ä¹‹åçš„è¡¨ç¤ºè¯¥å‡½æ•°ä¼šè¿”å›çš„è¡¨è¾¾å¼ç»“æœ
> æ³¨æ„ï¼Œè¿™é‡Œå¦‚æœèµ‹å€¼çš„è¯ï¼Œèµ‹å€¼çš„ä¸æ˜¯åŒ¿åå‡½æ•°è¿”å›çš„ç»“æœï¼Œè€Œæ˜¯åŒ¿åå‡½æ•°æœ¬èº«ï¼Œå³èµ‹å€¼äº†ä¸€ä¸ªå‡½æ•°

---
## step 18: yieldä¸è£…é¥°å™¨
> ï¼Ÿä¸è¦å¿˜è®°ï¼Œè¿™ä»½ç¬”è®°è®°å½•çš„æ˜¯ä¹¦æœ¬ä¸Šç®€ç•¥æåŠæˆ–è€…è·³è¿‡çš„ä¸œè¥¿ï¼Œæ‰€ä»¥çœ‹åˆ°æ ‡é¢˜å’Œç« èŠ‚æ ‡é¢˜ä¸ç¬¦ä¸è¦å¥‡æ€ª

### 1. yield
å¯ä»¥å‚è€ƒè¿™ç¯‡[åšå®¢](https://blog.csdn.net/mieleizhi0522/article/details/82142856)
å¯¹äºæˆ‘ä»¬çš„ä»£ç æ¥è¯´ï¼Œæ ¸å¿ƒç”¨åˆ°çš„ç‰¹æ€§ï¼Œå°±æ˜¯ï¼š
- ä½ ç¬¬ä¸€æ¬¡æ‰§è¡Œå«æœ‰yieldçš„å‡½æ•°æ—¶ï¼Œç¨‹åºä¼šè¿è¡Œåˆ°yieldçš„ä½ç½®ï¼Œç„¶åè¡¨é¢ä¸Šç±»ä¼¼returnä¸€æ ·è¿”å›
- ä½†æ˜¯å½“ä½ ä¸‹ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œä¼šä»yieldçš„ä¸‹ä¸€è¡Œå¼€å§‹æ¥ç€æ‰§è¡Œç¨‹åº
- åœ¨å‡½æ•°æš‚åœï¼ˆyieldï¼‰æ—¶ï¼Œæ‰€æœ‰å±äºè¯¥å‡½æ•°çš„å±€éƒ¨å˜é‡ã€æ‰§è¡Œä½ç½®éƒ½ä¼šè¢«æ ˆä¿å­˜ï¼Œä¸ä¼šåƒreturné‚£æ ·é”€æ¯

### 2. @contextlib.contextmanager è£…é¥°å™¨
1. ä»€ä¹ˆæ˜¯è£…é¥°å™¨ï¼Ÿ
	è£…é¥°å™¨ï¼Œè£…é¥°å™¨ï¼Œé¡¾åæ€ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæš‚æ—¶ç†è§£ä¸ºï¼šä¸€ä¸ª â€œåŒ…è£…å‡½æ•°â€ï¼Œèƒ½åœ¨ä¸æ”¹åŠ¨åŸå‡½æ•°ä»£ç çš„å‰æä¸‹ï¼Œç»™åŸå‡½æ•°åŠ å‰ç½® / åç½®é€»è¾‘ã€‚æ¡ˆä¾‹å¦‚ä¸‹ï¼š
	```python
	# å®šä¹‰è£…é¥°å™¨ï¼šç»™å‡½æ•°åŠ â€œæ‰§è¡Œæ—¥å¿—â€åŠŸèƒ½
	def log_decorator(func):
		# åŒ…è£…å‡½æ•°ï¼šæ¥æ”¶åŸå‡½æ•°çš„å‚æ•°ï¼Œæ‰§è¡Œå¢å¼ºé€»è¾‘
		def wrapper(*args, **kwargs):
			print(f"å¼€å§‹æ‰§è¡Œå‡½æ•°ï¼š{func.__name__}")  # å‰ç½®é€»è¾‘
			result = func(*args, **kwargs)          # æ‰§è¡ŒåŸå‡½æ•°
			print(f"å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼š{func.__name__}")  # åç½®é€»è¾‘
			return result
		return wrapper

	# ä½¿ç”¨è£…é¥°å™¨ï¼š@+è£…é¥°å™¨åï¼Œæ”¾åœ¨å‡½æ•°å®šä¹‰ä¸Šæ–¹
	@log_decorator
	def square(x):
		return x * x

	# è°ƒç”¨åŸå‡½æ•°ï¼Œè‡ªåŠ¨è§¦å‘è£…é¥°å™¨é€»è¾‘
	print(square(2))
	# è¾“å‡ºï¼š
	# å¼€å§‹æ‰§è¡Œå‡½æ•°ï¼šsquare
	# å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼šsquare
	# 4
	``` 
	ä½ çŒœçŒœè¿™ä¸ªå’Œä»€ä¹ˆç­‰ä»·ï¼Ÿ
	```python
	# å®šä¹‰è£…é¥°å™¨ï¼šç»™å‡½æ•°åŠ â€œæ‰§è¡Œæ—¥å¿—â€åŠŸèƒ½
	def log_decorator(func):
		# åŒ…è£…å‡½æ•°ï¼šæ¥æ”¶åŸå‡½æ•°çš„å‚æ•°ï¼Œæ‰§è¡Œå¢å¼ºé€»è¾‘
		def wrapper(*args, **kwargs):
			print(f"å¼€å§‹æ‰§è¡Œå‡½æ•°ï¼š{func.__name__}")  # å‰ç½®é€»è¾‘
			result = func(*args, **kwargs)          # æ‰§è¡ŒåŸå‡½æ•°
			print(f"å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼š{func.__name__}")  # åç½®é€»è¾‘
			return result
		return wrapper

	# ä½¿ç”¨è£…é¥°å™¨ï¼š@+è£…é¥°å™¨åï¼Œæ”¾åœ¨å‡½æ•°å®šä¹‰ä¸Šæ–¹
	def square(x):
		return x * x

	square = log_decorator(square)
	# è°ƒç”¨åŸå‡½æ•°ï¼Œè‡ªåŠ¨è§¦å‘è£…é¥°å™¨é€»è¾‘
	print(square(2))
	# è¾“å‡ºï¼š
	# å¼€å§‹æ‰§è¡Œå‡½æ•°ï¼šsquare
	# å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼šsquare
	# 4
	``` 
	æ¬¸ï¼Œçœ‹æ¥æ˜¯ä¸æ˜¯æœ‰ç‚¹çœ‰ç›®äº†ï¼Ÿè¯´ç™½äº†è£…é¥°å™¨ï¼Œè¯´ç™½äº†è£…é¥°å™¨æœ¬è´¨æ˜¯è¿”å›â€œåŒ…è£…å‡½æ•°wrapperâ€çš„å‡½æ•°ï¼Œwrapperé‡Œä¼šä¸­é€”è°ƒç”¨åŸå‡½æ•°ã€‚ç„¶åä¸ºäº†å·æ‡’ï¼Œç»™ä½ æ•´äº†ä¸€ä¸ªå¾ˆæŠ½è±¡çš„å†™æ³• `@xxx`ï¼Œå¹¶ä¸”è¦æ±‚ä½ æ”¾åœ¨å‡½æ•°çš„æ­£ä¸Šæ–¹ã€‚é¢~ä¸å¥½è¯„ä»·ã€‚Â¯\\_(ãƒ„)_/Â¯
	> è€Œè¿™ä¸ªå¾ˆæŠ½è±¡çš„ç®€å†™ï¼Œå°±æ˜¯æ‰€è°“çš„ â€œè¯­æ³•ç³–â€ã€‚ğŸ™ƒ

2. ä»€ä¹ˆæ˜¯ `with`
	with æ˜¯ Python å¯¹ã€Œä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€çš„è¯­æ³•ç³– â€”â€” åªè¦ä¸€ä¸ªå¯¹è±¡å®ç°äº† `__enter__` å’Œ `__exit__` æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯ â€œä¸Šä¸‹æ–‡ç®¡ç†å™¨â€ï¼‰ï¼Œå°±èƒ½ç”¨ with è°ƒç”¨ã€‚
	- è¿›å…¥ `with`
	- æ‰§è¡Œ `__enter__`
	- æ‰§è¡Œ `with` çš„å—å†…é€»è¾‘
	- é€€å‡º `with`
	- æ‰§è¡Œ `__exit__`
3. ä»€ä¹ˆæ˜¯ `@contextlib.contextmanager`
   åœ¨ä½ ç†è§£ä»€ä¹ˆæ˜¯è£…é¥°å™¨åï¼Œçœ‹è¿™ä¸ªå°±å®¹æ˜“ç†è§£å¤šäº†ï¼š
   - å®ƒæ¥æ”¶ä¸€ä¸ªã€Œå¸¦ yield çš„å‡½æ•°ã€ï¼Œè¿”å›ä¸€ä¸ªã€ŒåŒ…è£…åçš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨å‡½æ•°ã€ï¼›
   - è¿™ä¸ªè£…é¥°å™¨æ˜¯ â€œæ¡¥æ¢â€ï¼ŒæŠŠä¸€ä¸ªå¸¦ yield çš„æ™®é€šå‡½æ•°ï¼Œè½¬æ¢æˆèƒ½è¢« with è°ƒç”¨çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š
     - é€šè¿‡ yield åˆ†å‰² â€œè¿›å…¥ä¸Šä¸‹æ–‡â€ å’Œ â€œé€€å‡ºä¸Šä¸‹æ–‡â€ çš„é€»è¾‘ã€‚
   - ç”¨ with è°ƒç”¨æ—¶ï¼Œè£…é¥°å™¨ç”Ÿæˆçš„wrapperä¼šè‡ªåŠ¨å¤„ç†ï¼šæ‰§è¡Œyieldå‰é€»è¾‘ â†’ æš‚åœï¼ˆæ‰§è¡Œwithå—å†…ä»£ç ï¼‰â†’ æ‰§è¡Œyieldåé€»è¾‘

---
## Step 39: ä¹¦ä¸­æœªè®²æ˜çš„ utils.reshape_sum_backward() å‡½æ•°åˆ†æ
### 1. ä½¿ç”¨çš„åœºæ™¯
é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å‡½æ•°è°ƒç”¨çš„åœ°æ–¹å’Œä½¿ç”¨çš„èƒŒæ™¯ï¼š
```python
class Sum(Function):
	def __init__(self, axis, keepdims):
		self.axis = axis
		self.keepdims = keepdims
	
	def forward(self, x):
		self.x_shape = x.shape
		return x.sum(axis = self.axis, keepdims = self.keepdims)	# è¿™é‡Œå…¶å®æ˜¯ np.sum()
	
	def backward(self, gy):
		gy = utils.reshape_sum_backward(gy, self.x_shape, self.axis, self.keepdims) 	# å› ä¸ºä½¿ç”¨ axis å’Œ keepdims ä¼šå‡ºç°æ”¹å˜æ¢¯åº¦å½¢çŠ¶çš„æƒ…å†µï¼Œæ‰€ä»¥è¦ä¿®æ­£
		return broadcast_to(gy, self.x_shape)

def sum(x, axis = None, keepdims = False):
	return Sum(axis, keepdims)(x)
```
å…³äºä½¿ç”¨çš„åŸå› ï¼Œä¹¦ä¸­çš„åŸæ–‡å¦‚ä¸‹ã€‚ä¸€è¨€ä»¥è”½ä¹‹ï¼Œå³ ***å½¢çŠ¶å‰åæœ‰å˜åŒ–ï¼Œéœ€è¦è°ƒæ•´***ã€‚
> åœ¨åå‘ä¼ æ’­çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬åœ¨ broadcast_to å‡½æ•°ä¹‹å‰ä½¿ç”¨äº† utils.reshape_sum_backward å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¼šå¯¹ gy çš„å½¢çŠ¶ç¨åŠ è°ƒæ•´ï¼ˆå› ä¸ºä½¿ç”¨ axis å’Œ keepdims æ±‚å’Œæ—¶ä¼šå‡ºç°æ”¹å˜æ¢¯é˜Ÿå½¢çŠ¶çš„æƒ…å†µï¼‰ã€‚

### 2. å‡½æ•°çš„å…·ä½“åˆ†æ
è°ƒç”¨çš„å‡½æ•°ä»£ç å¦‚ä¸‹
```python
def reshape_sum_backward(gy, x_shape, axis, keepdims):
    """Reshape gradient appropriately for dezero.functions.sum's backward.

    Args:
        gy (dezero.Variable): Gradient variable from the output by backprop.
        x_shape (tuple): Shape used at sum function's forward.
        axis (None or int or tuple of ints): Axis used at sum function's
            forward.
        keepdims (bool): Keepdims used at sum function's forward.

    Returns:
        dezero.Variable: Gradient variable which is reshaped appropriately
    """
    ndim = len(x_shape)
    tupled_axis = axis
    if axis is None:
        tupled_axis = None
    elif not isinstance(axis, tuple):
        tupled_axis = (axis,)

    if not (ndim == 0 or tupled_axis is None or keepdims):
        actual_axis = [a if a >= 0 else a + ndim for a in tupled_axis]
        shape = list(gy.shape)
        for a in sorted(actual_axis):
            shape.insert(a, 1)
    else:
        shape = gy.shape

    gy = gy.reshape(shape)  # reshape
    return gy
```
- å˜é‡åˆå§‹åŒ–ä¸è½´çš„æ ‡å‡†åŒ–
	```python
	ndim = len(x_shape)  				# è·å–åŸè¾“å…¥xçš„ç»´åº¦æ•°ï¼ˆæ¯”å¦‚x_shape=(2,3)ï¼Œndim=2ï¼‰
	tupled_axis = axis
	if axis is None:
		tupled_axis = None 				# axis=Noneè¡¨ç¤ºå¯¹æ‰€æœ‰å…ƒç´ æ±‚å’Œï¼ˆæ¯”å¦‚(2,3)â†’()ï¼‰
	elif not isinstance(axis, tuple):
		tupled_axis = (axis,)  			# æŠŠå•ä¸ªè½´ï¼ˆå¦‚axis=1ï¼‰è½¬æˆå…ƒç»„(1,)ï¼Œç»Ÿä¸€å¤„ç†æ ¼å¼
	```
	- ç›®çš„ï¼šæŠŠå„ç§å½¢å¼çš„ axisï¼ˆNone / å•ä¸ª int / å…ƒç»„ï¼‰ç»Ÿä¸€æˆ â€œNone æˆ–å…ƒç»„â€ çš„æ ¼å¼ï¼Œæ–¹ä¾¿åç»­å¤„ç†ã€‚
	- ä¸¾ä¾‹ï¼š
		- è¾“å…¥ axis=0 â†’ è½¬æˆ (0,)
		- è¾“å…¥ axis=(0,1) â†’ ä¿æŒä¸å˜
		- è¾“å…¥ axis=None â†’ ä¿æŒ None
- æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ’å…¥ç»´åº¦
	```python
	if not (ndim == 0 or tupled_axis is None or keepdims):
		# æƒ…å†µ1ï¼šéœ€è¦æ’å…¥ç»´åº¦ï¼ˆæœ€å¸¸è§çš„åœºæ™¯ï¼‰
		actual_axis = [a if a >= 0 else a + ndim for a in tupled_axis]
		shape = list(gy.shape)			# è½¬æ¢ä¸ºåˆ—è¡¨
		for a in sorted(actual_axis):
			shape.insert(a, 1)			
			# insert æ˜¯ Python åˆ—è¡¨ï¼ˆlistï¼‰çš„å†…ç½®æ–¹æ³• 
			# è¯­æ³•ï¼š`åˆ—è¡¨.insert(ç´¢å¼•ä½ç½®, è¦æ’å…¥çš„å…ƒç´ )`
			# ä½œç”¨ï¼šåœ¨æŒ‡å®šç´¢å¼•ä½ç½®æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼ŒåŸä½ç½®åŠä¹‹åçš„å…ƒç´ ä¼šè‡ªåŠ¨å‘åç§»ä¸€ä½ï¼›
	else:
		# æƒ…å†µ2ï¼šä¸éœ€è¦æ’å…¥ç»´åº¦
		shape = gy.shape
	```
	- åˆ¤æ–­æ¡ä»¶ not (ndim == 0 or tupled_axis is None or keepdims)ï¼š
      - ndim == 0ï¼šåŸè¾“å…¥ x æ˜¯æ ‡é‡ï¼ˆshape=()ï¼‰ï¼Œæ— éœ€é‡å¡‘ã€‚
      - tupled_axis is Noneï¼šsum æ—¶å¯¹æ‰€æœ‰ç»´åº¦æ±‚å’Œï¼ˆæ¯”å¦‚ x æ˜¯ (2,3)ï¼Œsum åæ˜¯æ ‡é‡ï¼‰ï¼Œgy å·²æ˜¯æ ‡é‡ï¼Œæ— éœ€é‡å¡‘
      - keepdims=Trueï¼šsum æ—¶ä¿ç•™äº†ç»´åº¦ï¼ˆæ¯”å¦‚ (2,3) æ²¿ axis=1 sum åæ˜¯ (2,1)ï¼‰ï¼Œgy å½¢çŠ¶å·²åŒ¹é…ï¼Œæ— éœ€æ’å…¥ 1
      - åªæœ‰ä»¥ä¸Šéƒ½ä¸æ»¡è¶³æ—¶ï¼Œæ‰éœ€è¦ç»™ gy æ’å…¥ç»´åº¦ 1
      - å³ **ä¸æ˜¯æ ‡é‡** å¹¶ä¸” **æŒ‡å®šäº†axis** å¹¶ä¸” **æ²¡æœ‰å¼€å¯keepdims**
    - if æ¡†ä½“è§£é‡Š
      - actual_axisï¼šå¤„ç†è´Ÿè½´ï¼ˆæ¯”å¦‚ axis=-1ï¼Œndim=2 â†’ å®é™…æ˜¯ axis=1ï¼‰ï¼Œè½¬æˆéè´Ÿç´¢å¼•ï¼Œé¿å…è¶Šç•Œã€‚
      - shape.insert(a, 1)ï¼šåœ¨æŒ‡å®šè½´çš„ä½ç½®æ’å…¥ 1ï¼ŒæŠŠ gy çš„å½¢çŠ¶è¿˜åŸæˆ â€œå‹ç¼©å‰çš„ç»´åº¦ï¼ˆåªæ˜¯å‹ç¼©è½´å˜æˆ 1ï¼‰â€ã€‚
    - ä½œç”¨ï¼šç»¼ä¸Šï¼Œå°†é€‰å®šçš„æ±‚å’Œå¯¼è‡´è¢«å‹ç¼©æ‰çš„axisç»´åº¦ç»™ä»–è¿˜åŸå‡ºæ¥ï¼ˆåœ¨è¯¥ç»´åº¦å°ºå¯¸è®¾ç½®ä¸º1å³å¯ï¼‰ï¼Œä»¥ä¾¿äºå¹¿æ’­
    - ä¸¾ä¾‹ï¼š
      - æ­£å‘ä¼ æ’­ï¼šx.shape=(2,3)ï¼Œsum (axis=1) â†’ è¾“å‡º shape=(2,)ï¼Œkeepdims=False
      - åå‘ä¼ æ’­ï¼šgy.shape=(2,)
        - actual_axis = [1]ï¼ˆaxis=1 æ˜¯æ­£ç´¢å¼•ï¼Œæ— éœ€è½¬æ¢ï¼‰
        - shape åˆå§‹æ˜¯ [2]
        - å¯¹ sorted åçš„ axis=1 æ‰§è¡Œ insert (1,1) â†’ shape å˜æˆ [2,1]
        - æœ€ç»ˆ gy.reshape ([2,1])ï¼Œåç»­å¹¿æ’­å°±èƒ½è¿˜åŸæˆ (2,3)
- æ‰§è¡Œé‡å¡‘å¹¶è¿”å›
	```python
	gy = gy.reshape(shape)  # æŠŠgyé‡å¡‘æˆè®¡ç®—å¥½çš„shape
	return gy
	```
	- æŠŠ gy çš„å½¢çŠ¶è°ƒæ•´ä¸ºæ’å…¥äº† 1 çš„ç»´åº¦ï¼Œä¸ºåç»­çš„å¹¿æ’­ï¼ˆåå‘ä¼ æ’­çš„æ¢¯åº¦ç´¯åŠ ï¼‰åšå‡†å¤‡ã€‚

---
## Step 40: ä¹¦ä¸­æœªè®²æ˜çš„ utils.sum_to å‡½æ•°åˆ†æ
```python
def sum_to(x, shape):
    """Sum elements along axes to output an array of a given shape.

    Args:
        x (ndarray): Input array.
        shape:

    Returns:
        ndarray: Output array of the shape.
    """
	#! NumPy çš„å¹¿æ’­æ€»æ˜¯ä»å³å‘å·¦å¯¹é½ç»´åº¦ï¼Œåªåœ¨å·¦ä¾§ï¼ˆå‰é¢ï¼‰è¡¥å……å¤§å°ä¸º 1 çš„ç»´åº¦ï¼Œä¸”ä»…å½“å¯¹åº”ç»´åº¦ç›¸ç­‰æˆ–å…¶ä¸­ä¸€æ–¹ä¸º 1 æ—¶æ‰èƒ½å¹¿æ’­ï¼Œä¸èƒ½åœ¨å³ä¾§ï¼ˆæœ«å°¾ï¼‰æ–°å¢ç»´åº¦ã€‚
    ndim = len(shape)
    lead = x.ndim - ndim
	# lead = x.ndim - ndim åªèƒ½è¡¨ç¤ºâ€œå‰é¢å¤šå‡ºæ¥çš„ç»´åº¦â€ï¼Œä¸èƒ½å¤„ç†â€œåé¢å¤šå‡ºæ¥çš„ç»´åº¦â€ã€‚è¿™æ˜¯å› ä¸º NumPy çš„å¹¿æ’­è§„åˆ™æ˜¯ä»åå¾€å‰å¯¹é½ç»´åº¦çš„ï¼Œè€Œè¯¥å‡½æ•°çš„è®¾è®¡æ­£æ˜¯åŸºäºè¿™ä¸€è§„åˆ™ã€‚

    lead_axis = tuple(range(lead))

    axis = tuple([i + lead for i, sx in enumerate(shape) if sx == 1])
    y = x.sum(lead_axis + axis, keepdims=True)	# åªå‘å‹ç¼©æ‰çš„ç»´åº¦å’Œä¸º1çš„ç»´åº¦è¿›è¡Œsumæ±‚å’Œ
    if lead > 0:
        y = y.squeeze(lead_axis)				# å°†leadçš„ç»´åº¦åˆ é™¤æ‰ï¼Œæ¯”å¦‚ shape(1,2,3)->(squeeze)->(2,3)
    return y
```
### 1. ä½ åº”è¯¥çŸ¥é“çš„ numpy å¹¿æ’­ç‰¹ç‚¹
NumPy çš„å¹¿æ’­æ€»æ˜¯**ä»å³å‘å·¦å¯¹é½ç»´åº¦**ï¼Œåªåœ¨**å·¦ä¾§ï¼ˆå‰é¢ï¼‰è¡¥å……å¤§å°ä¸º 1 çš„ç»´åº¦**ï¼Œä¸”**ä»…å½“** **å¯¹åº”ç»´åº¦ç›¸ç­‰æˆ–å…¶ä¸­ä¸€æ–¹ä¸º 1 æ—¶**æ‰èƒ½å¹¿æ’­ï¼Œä¸èƒ½åœ¨å³ä¾§ï¼ˆæœ«å°¾ï¼‰æ–°å¢ç»´åº¦ã€‚
- æ­£ä¾‹ï¼š
	```python
	import numpy as np

	a = np.ones((3,))        # shape: (3,)
	b = np.ones((2, 4, 3))   # shape: (2, 4, 3)

	# a ä¼šè¢«å¹¿æ’­ä¸º (1, 1, 3) â†’ å†å¹¿æ’­ä¸º (2, 4, 3)
	c = a + b
	print(c.shape)  # è¾“å‡º: (2, 4, 3)
	```
	ä¸ºä»€ä¹ˆåˆæ³•ï¼Ÿ
    - NumPy å°† a.shape = (3,) åœ¨å·¦ä¾§è¡¥ 1 â†’ (1, 1, 3)ï¼ˆç¬¦åˆâ€œåªåœ¨å·¦ä¾§è¡¥å……ç»´åº¦â€ï¼‰ï¼›
    - ä»å³å‘å·¦å¯¹é½ï¼š
      - ç¬¬ -1 ç»´ï¼š3 vs 3 â†’ ç›¸ç­‰ âœ…
      - ç¬¬ -2 ç»´ï¼š1 vs 4 â†’ æœ‰ 1 âœ…
      - ç¬¬ -3 ç»´ï¼š1 vs 2 â†’ æœ‰ 1 âœ…
      - æ²¡æœ‰åœ¨æœ«å°¾æ–°å¢ç»´åº¦ï¼ˆa çš„ 3 åœ¨æœ€å³è¾¹ï¼Œå’Œ b çš„ 3 å¯¹é½ï¼‰âœ…
- è´Ÿä¾‹1ï¼š
	```python
	import numpy as np

	a = np.ones((2, 3))      # shape: (2, 3)
	b = np.ones((2, 3, 4))   # shape: (2, 3, 4)

	# å°è¯•è¿ç®—ä¼šæŠ¥é”™ï¼
	c = a + b  # âŒ ValueError!
	```
	ä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿ
    - a.shape = (2, 3) éœ€è¦å’Œ (2, 3, 4) å¯¹é½ï¼›
    - NumPy åœ¨å·¦ä¾§è¡¥ 1ï¼ša â†’ (1, 2, 3)ï¼›
    - ä»å³å‘å·¦å¯¹é½æ¯”è¾ƒï¼š
      - ç¬¬ -1 ç»´ï¼š3 vs 4 â†’ æ—¢ä¸ç›¸ç­‰ï¼Œä¹Ÿæ²¡æœ‰ 1 âŒï¼ˆåé¢çš„ç»´åº¦ä¸ç”¨çœ‹äº†ï¼Œå·²ç»å¤±è´¥ï¼‰
- è´Ÿä¾‹2ï¼š
	```python
	import numpy as np

	a = np.ones((2, 4))      # shape: (2, 4)
	b = np.ones((2, 3, 4))   # shape: (2, 3, 4)

	# å°è¯•è¿ç®—ä¼šæŠ¥é”™ï¼
	c = a + b  # âŒ ValueError!
	```
	ä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿ
    - NumPy å°† a.shape = (2, 4) åœ¨å·¦ä¾§è¡¥ 1 â†’ å˜ä¸º (1, 2, 4)
    - ä»å³å‘å·¦å¯¹é½æ¯”è¾ƒï¼š
      - ç¬¬ -1 ç»´ï¼š4 vs 4 â†’ âœ… ç›¸ç­‰
      - ç¬¬ -2 ç»´ï¼š2 vs 3 â†’ âŒ æ—¢ä¸ç›¸ç­‰ï¼Œä¹Ÿæ²¡æœ‰ 1
      - ç¬¬ -3 ç»´ï¼š1 vs 2 â†’ âœ… æœ‰ 1
    - ç”±äºç¬¬ -2 ç»´å†²çªï¼Œå¹¿æ’­å¤±è´¥ã€‚

### 2. å…·ä½“å‡½æ•°åˆ†æ
sum_to(x, shape) çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼šå°†é€šè¿‡å¹¿æ’­æ‰©å±•å¾—åˆ°çš„æ•°ç»„ xï¼Œè¿˜åŸï¼ˆå‹ç¼©ï¼‰å›å…¶åŸå§‹å½¢çŠ¶ shapeã€‚è¿™åœ¨åå‘ä¼ æ’­ä¸­éå¸¸å…³é”®â€”â€”å½“ä¸€ä¸ªè¾ƒå°çš„å¼ é‡å‚ä¸å‰å‘è®¡ç®—å¹¶è¢«å¹¿æ’­æˆæ›´å¤§çš„å¼ é‡æ—¶ï¼Œå…¶æ¢¯åº¦ä¼šä»¥æ›´å¤§å½¢çŠ¶è¿”å›ï¼›æˆ‘ä»¬éœ€è¦å°†è¿™äº›æ¢¯åº¦â€œèšåˆâ€å›åŸå§‹çš„å°å½¢çŠ¶ï¼Œè€Œ sum_to æ­£æ˜¯å®Œæˆè¿™ä¸€èšåˆæ“ä½œçš„å·¥å…·ã€‚

æ¥ä¸‹æ¥å‡½æ•°é€»è¾‘é€è¡Œè§£æ
```python
ndim = len(shape)
lead = x.ndim - ndim
```
- å…³é”®å‡è®¾ï¼šè¿™äº›å¤šå‡ºçš„ç»´åº¦ä¸€å®šåœ¨æœ€å‰é¢ï¼ˆå› ä¸ºå¹¿æ’­åªåœ¨å·¦ä¾§è¡¥ç»´ï¼‰ã€‚*å°±æ˜¯æˆ‘å‰æ–‡å«ä½ äº†è§£çš„å†…å®¹å—·
- ndimï¼šç›®æ ‡å½¢çŠ¶çš„ç»´åº¦æ•°ã€‚
- leadï¼šè¾“å…¥ x æ¯”ç›®æ ‡å¤šå‡ºçš„ç»´åº¦æ•°é‡ã€‚

```python
ndim = len(shape)
lead = x.ndim - ndim
```
- lead_axis = tuple(range(lead))

```python
axis = tuple([i + lead for i, sx in enumerate(shape) if sx == 1])	# sx æ˜¯ sum_to å‡½æ•°åˆ—è¡¨æ¨å¯¼å¼ä¸­çš„ä¸´æ—¶å˜é‡ï¼Œä»£è¡¨ç›®æ ‡å½¢çŠ¶ç¬¬ i è½´çš„å°ºå¯¸å€¼
```
- éå†ç›®æ ‡ shapeï¼Œæ‰¾å‡ºæ‰€æœ‰å€¼ä¸º 1 çš„ç»´åº¦ä½ç½® iï¼›
- å°†å…¶æ˜ å°„å› x ä¸­çš„å®é™…è½´ç´¢å¼•ï¼ši + leadï¼ˆå› ä¸ºå‰é¢å¤šäº† lead ä¸ªç»´åº¦ï¼‰ï¼›
- è¿™äº›è½´åœ¨å‰å‘ä¼ æ’­ä¸­åŸæœ¬æ˜¯ 1ï¼Œè¢«å¹¿æ’­æˆäº†æ›´å¤§çš„å€¼ï¼ˆå¦‚ 1 â†’ 5ï¼‰ï¼Œå› æ­¤åœ¨åå‘ä¼ æ’­ä¸­éœ€è¦æ²¿è¿™äº›è½´æ±‚å’Œï¼ŒæŠŠæ¢¯åº¦â€œæ”¶å›æ¥â€ã€‚
- æ‹†è§£æˆå¾ªç¯å¯èƒ½æ›´å¥½ç†è§£
	```python
	axis = []
	# éå†ç›®æ ‡å½¢çŠ¶ shapeï¼Œi æ˜¯è½´ç´¢å¼•ï¼Œsx æ˜¯è¯¥è½´çš„å°ºå¯¸å€¼
	for i, sx in enumerate(shape):
		if sx == 1:  # åªå…³æ³¨ç›®æ ‡å½¢çŠ¶ä¸­å°ºå¯¸ä¸º1çš„è½´
			axis.append(i + lead)
	axis = tuple(axis)
	```

```python
y = x.sum(lead_axis + axis, keepdims=True)
```
- åŒæ—¶å¯¹ å‰å¯¼ç»´åº¦ å’Œ åŸä¸º 1 çš„ç»´åº¦ æ±‚å’Œï¼›
- keepdims=True ä¿è¯æ±‚å’Œåè¿™äº›ç»´åº¦ä»ä¿ç•™ä¸ºå¤§å° 1ï¼Œä¾¿äºåç»­å½¢çŠ¶è°ƒæ•´ã€‚

```python
if lead > 0:
    y = y.squeeze(lead_axis)
```
- åˆ é™¤å‰å¯¼ç»´åº¦ï¼ˆå®ƒä»¬å·²ç»æ˜¯å¤§å°ä¸º 1ï¼‰ï¼Œä½¿æœ€ç»ˆå½¢çŠ¶ä¸¥æ ¼ç­‰äº shapeã€‚

---
## Step 44: `super()` ä»¥åŠ `__setattr__`

### 1. `super()`
`super()`æ˜¯pythonè°ƒç”¨çˆ¶ç±»çš„æŸä¸€ä¸ªå‡½æ•°çš„åŠæ³•ã€‚å¦‚ä½ åœ¨å­ç±»å’Œçˆ¶ç±»éƒ½åŒæ—¶å®šä¹‰äº† foo å‡½æ•°ï¼Œä½†æ˜¯ç”¨æ³•ç•¥æœ‰ä¸åŒï¼Œä½ åœ¨å­ç±»ä¸­å¸Œæœ›å®ç°æ–°åŠŸèƒ½çš„åŒæ—¶ï¼Œä¹Ÿæœ‰çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½ æœ‰ä¸åƒæ•´ä¸ªé‡å†™ä¸€éçˆ¶ç±»çš„åŠŸèƒ½ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä½ å°±å¯ä»¥åœ¨å­ç±»ä¸­è°ƒç”¨çˆ¶ç±»çš„fooæ¥å®ç°ã€‚
```python
class Parent:
    def foo(self, x):
        print("Parent foo:", x)

class Child(Parent):
    def foo(self, x, y):
        super().foo(x)  # è°ƒç”¨çˆ¶ç±»çš„ foo
        print("Child extra:", y)
```
ä¸è¿‡æ³¨æ„ï¼šå³ä½¿ä½ çš„ç±»çœ‹èµ·æ¥æ²¡æœ‰æ˜¾å¼ç»§æ‰¿ä»»ä½•ç±»ï¼ˆå¦‚ class MyClass:ï¼‰ï¼Œå®ƒå®é™…ä¸Šä»ç„¶éšå¼ç»§æ‰¿è‡ª objectã€‚å› æ­¤ï¼Œå½“ä½ åœ¨è‡ªå®šä¹‰ç±»ä¸­å†™ `super().__setattr__(name, value)` æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ object ç±»çš„é»˜è®¤ `__setattr__` æ–¹æ³•ã€‚

### 2. `__setattr__` å³å…¶èµ‹å€¼è¯­æ³•
å½“ä½ çœ‹å®Œä¹¦ä¸­çš„ä»£ç æ—¶ï¼Œå¯èƒ½åˆä¼šå¯¹ä»¥ä¸‹çš„å†…å®¹äº§ç”Ÿå›°æƒ‘ï¼š
```python
layer = Layer()
layer.p1 = Parameter(np.array(1))
layer.p2 = Parameter(np.array(1))
```
ä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼šè¿™æ˜¯åœ¨åšä»€ä¹ˆï¼Ÿ
- è¿™æ˜¯åœ¨**åŠ¨æ€åœ°ä¸ºå®ä¾‹æ·»åŠ å±æ€§**ï¼ˆæ³¨æ„ï¼šæ˜¯å®ä¾‹ï¼Œä¸æ˜¯ç±»ï¼ï¼‰ã€‚
- æ¯æ¬¡æ‰§è¡Œ `obj.attr = value`ï¼ŒPython éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ `obj.__setattr__('attr', value)`ã€‚
> å­ç±»çš„æ•ˆæœä¹¦ä¸­å·²ç»è®²çš„æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œæˆ‘è¿™é‡Œå°±ç®€å•è®²è®²çˆ¶ç±»çš„[`object`ç±»]çš„ `__setattr__` æ–¹æ³•ï¼‰
- è¯­æ³•ï¼šå®ä¾‹.å±æ€§å=å±æ€§å€¼
- æ•ˆæœï¼šç»™å½“å‰**å®ä¾‹**ï¼ˆ*æ³¨æ„ï¼Œæ˜¯å®ä¾‹ï¼Œä¸æ˜¯ç±»ï¼*ï¼‰æ·»åŠ ä¸€ä¸ªæ–°çš„`å±æ€§`ï¼Œè¯¥`å±æ€§`çš„åç§°è®°ä½œ `ä¼ å…¥çš„å‚æ•°name`ï¼Œè¯¥å±æ€§çš„æ•°å€¼èµ‹å€¼ä¸º`ä¼ å…¥çš„å‚æ•°value`
> âš ï¸ å°å¿ƒé™·é˜±ï¼šåœ¨è‡ªå®šä¹‰ `__setattr__` æ–¹æ³•å†…éƒ¨ï¼Œ**ä¸è¦ç›´æ¥å†™** self.attr = valueï¼Œå¦åˆ™ä¼šå†æ¬¡è§¦å‘ `__setattr__`ï¼Œå¯¼è‡´æ— é™é€’å½’ï¼æ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨ `super().__setattr__(name, value)` æˆ–ç›´æ¥æ“ä½œ `self.__dict__`ã€‚
> 
> *`self.__dict__` æ˜¯ Python ä¸­æ¯ä¸ªå¯¹è±¡å®ä¾‹ï¼ˆinstanceï¼‰è‡ªå¸¦çš„ä¸€ä¸ªå­—å…¸ï¼ˆdictionaryï¼‰å±æ€§ï¼Œç”¨äºå­˜å‚¨è¯¥å®ä¾‹çš„æ‰€æœ‰å¯å˜å±æ€§ï¼ˆinstance attributesï¼‰ã€‚*

---
## Step 48: å¤ç°æ—¶é‡åˆ°çš„é—®é¢˜
åœ¨ å››åæ¥æ­¥ å¤åˆ»çš„æ—¶å€™æ˜æ˜¾ä¼šæ„Ÿåˆ°ä¸èˆ’æœè®¸å¤šï¼Œå› ä¸ºå¾ˆå¤šä»£ç äº’ç›¸åµŒå¥—ï¼Œä½†æ˜¯ä¹¦ä¸­æ²¡æœ‰æåŠä»€ä¹ˆæ—¶å€™å…·ä½“å®ç°çš„ã€‚
### 1. éœ€è¦å‚è€ƒé™„å½•Bå®ç° get_item
å…·ä½“å†…å®¹å‚è€ƒé™„å½•Bã€‚ä½†æ˜¯æ³¨æ„ï¼Œå®ç°åè®°å¾—æ·»åŠ å¦‚ä¸‹ä»£ç åˆ° `def setup_variable()`ï¼Œä¸ç„¶ä½ æ— æ³•åƒnpä¸€æ ·ä½¿ç”¨ç±»ä¼¼x[0]çš„æ–¹å¼æ¥è·å–æ•°ç»„å†…å®¹ï¼š
```python
	Variable.__getitem__ = dezero.functions.get_item
```
### 2. éœ€è¦åœ¨utilsä¸­è¡¥å……ä»£ç ï¼š
éšä¹¦é™„èµ çš„ä»£ç å·²ç»æ˜¯æœ€ç»ˆç‰ˆæœ¬çš„ï¼ŒåŒ…å«cupyç­‰ã€‚ä½†æŒ‰ç…§è¿›åº¦æ¥è¯´ï¼Œæ­¤å¤„è¿˜ä¸åº”è¯¥ç”¨åˆ°ï¼Œæ‰€ä»¥è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹
```python
def logsumexp(x, axis=1):
	# æºç åšè¿‡é˜²æ­¢æº¢å‡ºçš„ä¿®æ”¹
    m = x.max(axis=axis, keepdims=True)
    y = x - m
    np.exp(y, out=y)
    s = y.sum(axis=axis, keepdims=True)
    np.log(s, out=s)
    m += s
    return m
```
### 3. function ä¸­è¡¥å……çš„ä»£ç ï¼š
ç”¨äºé™åˆ¶æ•°å€¼èŒƒå›´çš„ä»£ç 
```python
class Clip(Function):
    def __init__(self, x_min, x_max):
        self.x_min = x_min
        self.x_max = x_max

    def forward(self, x):
        y = np.clip(x, self.x_min, self.x_max)	# np.clip å°†æ•°ç»„çš„æ‰€æœ‰å…ƒç´ é™åˆ¶åœ¨ [min, max] åŒºé—´å†…
        return y

    def backward(self, gy):
        x, = self.inputs
        mask = (x.data >= self.x_min) * (x.data <= self.x_max)
        gx = gy * mask
        return gx
def clip(x, x_min, x_max):
    return Clip(x_min, x_max)(x)
```

### 4. `t.ravel()`
`t.ravel()` æ˜¯ NumPy ä¸­ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„æ–¹æ³•ï¼Œç”¨äºå°†ä»»æ„å½¢çŠ¶çš„æ•°ç»„å±•å¹³ï¼ˆflattenï¼‰æˆä¸€ç»´æ•°ç»„ï¼Œä¸”å°½å¯èƒ½ä¸å¤åˆ¶æ•°æ®ã€‚
- å½“ä½ å†™ b = a.ravel()ï¼ŒNumPy å¹¶æ²¡æœ‰æŠŠ a çš„æ¯ä¸ªå…ƒç´ å†å­˜ä¸€é
- å®ƒåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„â€œæ•°ç»„å¯¹è±¡â€ï¼Œä½†åº•å±‚æ•°æ®æŒ‡é’ˆä»ç„¶æŒ‡å‘ a çš„å†…å­˜

---